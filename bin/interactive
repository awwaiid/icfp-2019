#!/usr/bin/env python

import os
import subprocess
import json
import readchar # install via: pip install readchar

engine = subprocess.Popen(
  'game_engine/engine.native',
  stdout=subprocess.PIPE,
  stdin=subprocess.PIPE,
  bufsize=0)

task_json = subprocess.check_output(["bin/parse-task","data/prob-001.desc"],universal_newlines=True)

engine.stdin.write(task_json.encode())
engine.stdin.write(b'\n')
result = engine.stdout.readline()
print(result.decode())

engine.stdin.write(b'{ "cmd": "get_state" }\n')
result = engine.stdout.readline()
state = json.loads(result.decode())
os.system('clear')
print(state['state_string'])

while True:
    c = readchar.readchar()
    engine.stdin.write(json.dumps({ "cmd": "action", "action": c.upper() }).encode())
    engine.stdin.write(b'\n')
    result = engine.stdout.readline()
    state = json.loads(result.decode())
    os.system('clear')
    print(state['state_string'])
    print('\n')
    print(state['action_string'])

engine.stdin.write(b'{ "cmd": "exit" }\n')
